<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="assets/images/logo.ico">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/index.css">

    <script src="js/tool.js"></script>

    <title>Reset Point</title>
</head>

<body>
    <div id="loading" class="content">
        <img src="assets/images/logo.png" alt="logo">
        <div id="animatedLoading">
            <div id="loadingBar"></div>
            <p id="loadingText" class="jersey-15">LOADING......</p>
        </div>
    </div>

    <div id="lobby" class="content">
        <div class="topTool">
            <!-- 個人資料 -->
            <div id="profile">
                <img src="assets/images/userProfile.png" alt="user profile">
                <div id="profileDetail">
                    <p id="profileName" class="lxgw-wenkai">用戶名稱</p>
                    <p id="profileId" class="lxgw-wenkai">#05132468</p>
                    <div id="profileExpBar">
                        <div id="profileExpBarFill"></div>
                    </div>
                </div>
            </div>
            <!-- 工具列 -->
            <div class="toolGroup">
                <button class="tool" id="resetpjBtn"></button>
                <button class="tool" id="removeBtn"></button>
                <button class="tool" id="musicBtn"></button>
                <button class="tool" id="settingBtn"></button>
            </div>
        </div>
        <div id="lobbyBody">
            <!-- 數值列表 -->
            <div id="reseterData">
                <p class="lxgw-wenkai">體力</p>
                <div class="dataBar">
                    <div id="strength" class="fill"></div>
                </div>
                <p class="lxgw-wenkai">智力</p>
                <div class="dataBar">
                    <div id="intelligence" class="fill"></div>
                </div>
                <p class="lxgw-wenkai">敏捷</p>
                <div class="dataBar">
                    <div id="agility" class="fill"></div>
                </div>
                <p class="lxgw-wenkai">運氣</p>
                <div class="dataBar">
                    <div id="fortune" class="fill"></div>
                </div>
            </div>
            <!-- 中心 -->
            <div id="game">
                <p id="gameName" class="noto-serif">甜蜜偽像</p>
                <div id="carouselContain">
                    <div id="carousel"></div>
                </div>
                <button id="enterBtn" class="enter jersey-15">ENTER</button>
            </div>
            <!-- 任務列表 -->
            <div id="mission">
                <div id="missionTitle">
                    <a href="mission.html">
                        <p class="jersey-15">MISSION</p>
                    </a>
                </div>
                <div id="missionDetail">
                    <a href="mission.html">
                        <p class="perMission lxgw-wenkai">通關[甜蜜偽像]所有結局<span class="missionRecord jersey-15">(0/5)</span>
                        </p>
                    </a>
                    <div class="line"></div>
                    <a href="mission.html">
                        <p class="perMission lxgw-wenkai">通關[甜蜜偽像]所有結局<span class="missionRecord jersey-15">(0/5)</span>
                        </p>
                    </a>
                    <div class="line"></div>
                    <a href="mission.html">
                        <p class="perMission lxgw-wenkai">通關[甜蜜偽像]所有結局<span class="missionRecord jersey-15">(0/5)</span>
                        </p>
                    </a>
                    <div class="line"></div>
                </div>
            </div>
        </div>
        <!-- 檔案資料 -->
        <div id="gameDetail" class="hide-scrollbar">
            <div id="gameIntro">
                <p id="gameIntroTitle" class="lxgw-wenkai">檔案資料</p>
                <p id="gameIntroContent" class="lxgw-wenkai"></p>
            </div>
            <div id="gameProgress">
                <p id="gameProgressTitle" class="lxgw-wenkai">重置進度 <span id="gameRecord">70</span>%</p>
                <div id="gameProgressBar">
                    <div id="fillGameProgressBar" class="fillGameProgressBar"></div>
                </div>
                <p id="unlockEndingTitle" class="lxgw-wenkai">解鎖結局（<span id="endingRecord">2/3</span>）</p>
                <div id="endings">
                    <!--<div class="unlockEndingCircle"></div>
                    <div class="lockEndingCircle"></div>
                    <div class="lockEndingCircle"></div>-->
                </div>
            </div>
        </div>
    </div>

    <script>
        const loadingBar = document.getElementById('loadingBar')
        const totalBlocks = 22
        const delayPerBlock = 3//300

        let isPageLoaded = false
        let isAnimationDone = false

        for (let i = 1; i <= totalBlocks; i++) {
            const block = document.createElement('div')
            block.className = 'loadingBlock'

            if (i === 1) block.id = 'leftBlock'
            if (i === totalBlocks) block.id = 'rightBlock'

            loadingBar.appendChild(block)

            setTimeout(() => {
                block.classList.add('visible')
            }, i * delayPerBlock)
        }

        const totalTime = (totalBlocks + 1) * delayPerBlock

        setTimeout(() => {
            isAnimationDone = true
            tryToEnterLobby()
        }, totalTime)

        window.onload = () => {
            isPageLoaded = true
            tryToEnterLobby()
        }

        function tryToEnterLobby() {
            if (isPageLoaded && isAnimationDone) {
                const userJson = localStorage.getItem('ResetPoint')

                if (!userJson) {
                    window.location.href = 'reset.html'
                    return
                }

                document.getElementById('loading').style.display = 'none'
                document.getElementById('lobby').style.display = 'block'
            }
        }

        const userJson = localStorage.getItem('ResetPoint')
        const user = JSON.parse(userJson)

        //遊戲名稱
        const gameNames = [
            '甜蜜偽像',
            '點燈人',
            '航海日誌',
            'CV-E20',
            '上行失效',
            '鏡像修正',
            '下水道收信人',
            '複寫公寓',
            '幻象折射',
            '分紅日',
            '目擊者',
            '偏差筆錄'
        ]

        //卡牌封面連結
        const imageUrls = [
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png',
            'assets/images/logo.png'
        ]

        //副本介紹
        const describes = [
            `[ RESET POINT SYSTEM // ACCESS LOG 003 ]<br>
            檔案名稱：甜蜜偽像（#RP-LUV-001-HONEY）<br>
            標籤：情感依附｜虛擬投射｜AI操控<br>
            狀態：模擬運行中／錯誤碼已累積（4）<br>
            風險：中度情感失控`,
            `[ RESET POINT SYSTEM // ACCESS LOG 004 ]<br>
            檔案名稱：點燈人（#RP-FLK-001-LANTERN）<br>
            標籤：民俗信仰｜異質召喚｜鄉村祭儀<br>
            狀態：觀察中／低頻事件回溯（2）<br>
            風險：輕度心理共振`,
            `[ RESET POINT SYSTEM // ACCESS LOG 005 ]<br>
            檔案名稱：航海日誌（#RP-SEA-001-SEA）<br>
            標籤：航海恐怖｜未知生物｜封閉空間<br>
            狀態：封鎖中／異常寫入終止（2）<br>
            風險：重度情感失控`,
            `[ RESET POINT SYSTEM // ACCESS LOG 001 ]<br>
            檔案名稱：CV-E20（#RP-MEM-001-CVE20）<br>
            標籤：記憶重疊｜疫情爆發｜雙重破壞<br>
            狀態：封鎖中／重構循環異常（5）<br>
            風險：中度記憶錯亂`,
            `[ RESET POINT SYSTEM // ACCESS LOG 006 ]<br>
            檔案名稱：上行失效（#RP-EVO-001-CLIMB）<br>
            標籤：空間錯亂｜樓層循環｜上行封鎖<br>
            狀態：觀察中／重構循環異常（2）<br>
            風險：輕度薄膜裂縫`,
            `[ RESET POINT SYSTEM // ACCESS LOG 007 ]<br>
            檔案名稱：鏡像修正（#RP-MEM-002-MIRRORFIX）<br>
            標籤：鏡像平行｜自我分裂｜替代意識<br>
            狀態：封鎖中／未知運行錯誤（7）<br>
            風險：中度認知紊亂`,
            ` RESET POINT SYSTEM // ACCESS LOG 008 ]<br>
            檔案名稱：下水道收信人（#RP-SOC-001-SEWER）<br>
            標籤：地下通訊｜反抗組織｜匿名任務<br>
            狀態：調查中／低頻事件回朔（3）<br>
            風險：中度心理共振`,
            `[ RESET POINT SYSTEM // ACCESS LOG 009 ]<br>
            檔案名稱：複寫公寓（#RP-MEM-003-COPYAPT）<br>
            標籤：複製時空｜時空重疊｜角色異常<br>
            狀態：異常刷新中／錯誤碼已累積（12）<br>
            風險：輕度系統錯誤`,
            `[ RESET POINT SYSTEM // ACCESS LOG 010 ]<br>
            檔案名稱：幻象折射（#RP-MEM-004-ILLUSION）<br>
            標籤：影像替代｜異常重現｜記憶紊亂<br>
            狀態：異常運行中／低頻事件回朔（3）<br>
            風險：重度認知紊亂`,
            `[ RESET POINT SYSTEM // ACCESS LOG 011 ]<br>
            檔案名稱：分紅日（#RP-SOC-002-DIVIDEND）<br>
            標籤：職場壓力｜精神崩潰｜社會淘汰<br>
            狀態：封鎖中／重構循環異常（1）<br>
            風險：輕度情感失控`,
            `[ RESET POINT SYSTEM // ACCESS LOG 012 ]<br>
            檔案名稱：目擊者（#RP-SOC-003-WITNESS）<br>
            標籤：匿名監控｜事件扭曲｜殺手真相<br>
            狀態：封鎖中／錯誤碼已累積（6）<br>
            風險：輕度心理共振`,
            `[ RESET POINT SYSTEM // ACCESS LOG 013 ]<br>
            檔案名稱：偏差筆錄（#RP-MEM-005-DEVIATION）<br>
            標籤：主觀現實｜錯亂敘事｜觀測干擾<br>
            狀態：監控中／未知運行錯誤（2）<br>
            風險：中度認知紊亂`
        ]

        const gameRecord = [
            `${(user.completedChapter + user.completedEndings) / 8} `,
            '? ',
            '? ',
            '? ',
            '? ',
            '? ',
            '? ',
            '? ',
            '? ',
            '? ',
            '? ',
            '? ',
        ]

        const endingRecord = [
            `${user.completedEndings} / 3`,
            '? / ?',
            '? / ?',
            '? / ?',
            '? / ?',
            '? / ?',
            '? / ?',
            '? / ?',
            '? / ?',
            '? / ?',
            '? / ?',
            '? / ?',
        ]

        const endings = {
            0: { endings: user.completedEndings, allEndings: 3 },
            1: { endings: 0, allEndings: 0 },
            2: { endings: 0, allEndings: 0 },
            3: { endings: 0, allEndings: 0 },
            4: { endings: 0, allEndings: 0 },
            5: { endings: 0, allEndings: 0 },
            6: { endings: 0, allEndings: 0 },
            7: { endings: 0, allEndings: 0 },
            8: { endings: 0, allEndings: 0 },
            9: { endings: 0, allEndings: 0 },
            10: { endings: 0, allEndings: 0 },
            11: { endings: 0, allEndings: 0 }
        }

        document.getElementById('profileExpBarFill').style.width = `${user.experience / 200 * 100}%`//經驗值比例
        document.getElementById('strength').style.width = `${user.strength}%`
        document.getElementById('intelligence').style.width = `${user.intelligence}%`
        document.getElementById('agility').style.width = `${user.agility}%`
        document.getElementById('fortune').style.width = `${user.fortune}%`

        const carousel = document.getElementById('carousel')
        const cardCount = 12
        const radius = 450
        const step = 360 / cardCount
        let angle = 0

        //建立卡片並加上 data-index
        for (let i = 0; i < cardCount; i++) {
            const card = document.createElement('div')
            card.className = 'card'
            card.dataset.index = i

            const img = document.createElement('img')
            img.className = 'cover'
            img.src = imageUrls[i]
            img.alt = gameNames[i]
            card.appendChild(img)

            const theta = step * i
            card.style.transform = `rotateY(${theta}deg) translateZ(${radius}px)`
            carousel.appendChild(card)
        }

        //設定放大卡牌
        function updateActiveCard() {
            const index = ((-angle / step) % cardCount + cardCount) % cardCount
            const roundedIndex = Math.round(index)

            document.querySelectorAll('.card').forEach(card => {
                const i = parseInt(card.dataset.index)
                const theta = step * i
                const isActive = i === Math.round(index)
                const scale = isActive ? 1.2 : 1
                card.style.transform = `rotateY(${theta}deg) translateZ(${radius}px) scale(${scale})`
                card.style.zIndex = isActive ? 10 : 1
            })

            document.getElementById('gameName').innerText = gameNames[roundedIndex]
            const enterBtn = document.getElementById('enterBtn')
            document.getElementById('gameIntroContent').innerHTML = describes[roundedIndex]
            document.getElementById('gameRecord').innerText = gameRecord[roundedIndex] * 100
            document.getElementById('fillGameProgressBar').style.width = `${(user.completedChapter + user.completedEndings) / 8 * 100}%`
            document.getElementById('endingRecord').innerText = endingRecord[roundedIndex]

            const container = document.getElementById('endings');
            container.innerHTML = ''
            console.log(roundedIndex)
            const unlocked = endings[roundedIndex].endings;
            const total = endings[roundedIndex].allEndings;

            for (let i = 0; i < total; i++) {
                const div = document.createElement('div');
                if (i < unlocked) {
                    div.className = 'unlockEndingCircle';
                } else {
                    div.className = 'lockEndingCircle';
                }
                container.appendChild(div);
            }

            if (gameNames[roundedIndex] == '甜蜜偽像') {
                enterBtn.innerText = 'ENTER'
                enterBtn.className = 'enter jersey-15'
            }
            else {
                enterBtn.innerText = 'LOCKED'
                enterBtn.className = 'locked jersey-15'
            }
        }

        //初次啟動就放大卡牌
        updateActiveCard()

        enterBtn.addEventListener('click', (e) => {
            if (document.getElementById('gameName').innerText == '甜蜜偽像') {
                window.location.href = 'root.html'
            }
        })

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') angle -= step
            if (e.key === 'ArrowLeft') angle += step
            carousel.style.transform = `rotateY(${angle}deg)`
            updateActiveCard()
        })

        document.getElementById('profileName').innerText = user.name
        document.getElementById('profileId').innerText = user.id

    </script>
</body>

</html>